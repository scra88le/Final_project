# (APPENDIX) Appendix {-} 

```{r loadLibsForAppx, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
library(tidymv)
library(gridExtra)
library(mgcv)
library(tune)
library(sf)
```

# Spatial plots of environmental covariates {#covar-plots}

```{r plotCovars, echo=FALSE, fig.asp=2, fig.height=14, fig.width=8, message=FALSE, warning=FALSE}
# Load covar data
pl_covars <- readRDS("~/Documents/GitHub/shetlandwaders/data/covars_df") %>%
  st_centroid() %>% 
  cbind(., sf::st_coordinates(.)) %>% 
  st_drop_geometry() %>%
  dplyr::select(-PLAN_NO,-area) %>%
  # Rename covariates
  rename('Elevation (m)'                   = elev,
         'Bog % cover'                     = D,
         'Grassland % cover'               = E,
         'Heathland % cover'               = `F`,
         'pH'                              = wgt_pH,
         'Topsoil Organic Carbon %'        = wgt_orgCarbon,
         'Available Water Capacity (kPA)'  = AWC,
         'Distance to sea (m)'             = dist_sea,
         'Bare peat % cover'               = bare_pc_cvr,
         'Improved grassland % cover'      = imp_gr_pc_df,
         'Marginal entropy'                = ent,
         'Conditional entropy'             = condent,
         'Joint entropy'                   = joinent,
         'Mutual information'              = mutinf,
         'Relative mutual informaton'      = relmutinf) %>%
  pivot_longer(cols = c(-X,-Y),
               names_to = "covariate", 
               values_to = "value") %>%
  na.omit() %>%
  filter(value > 0)


plot_func <- function(df, name) {
  ggplot(data = df, aes(x = X, y = Y, fill=value)) +
    coord_equal() +
    geom_tile(width = 1000, height = 1000) +
    ggtitle(name) +
    theme_minimal() + 
    scale_fill_distiller(palette = "Spectral") +
    theme(
      axis.text = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      plot.title = element_text(size = rel(0.7)),
      legend.key.width = unit(0.2, "cm"),
      legend.key.height = unit(.2, "cm"),
      legend.title = element_text(size = rel(0.7)),
      legend.text = element_text(size = rel(0.5)),
      panel.spacing = unit(c(0.1,0.1), "lines"),
      plot.margin = unit(c(0.1,0.1,0.1,0.1), "lines")
      
      ) 
}

nested_covars <- pl_covars %>% 
  group_by(covariate) %>% 
  nest() %>% 
  mutate(plots = map2(data, covariate , plot_func)) 

gridExtra::marrangeGrob(grobs = nested_covars$plots, ncol=3,nrow=5, top="")

```

# Parameters for GAM abundance response model {#gam-abun-response-params}

```{r tableGamParamsAbundance, message=FALSE, warning=FALSE, echo=FALSE, fig.align='left', fig.asp= 1.1, fig.cap='GAM parameter estimates, standard errors, z and P values from models incorporating parameteric terms associated with abundance (in 2002-2010 and 2011-2019)'}
# Load cached data
wader_df <- readRDS("~/Documents/GitHub/shetlandwaders/data/cacheddata/abun_gam_fit")
# create table of results of gam fit for each species - abundance response only
wader_df %>%
    dplyr::select(Species, period,covariate,estimate:p.value) %>%
    filter(period != "2002-2019") %>%
    kableExtra::kable(
      align = c('c','l','l','c','c','c','c'),
      col.names = c("Species","Response","Covariate",	"Estimate",	"se", "z", "p-value")) %>%
    kable_styling(full_width = T, font_size = 12) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:2, valign = "top") 
```

# Plots for GAM abundance response model {#gam-abun-response-plots}

```{r responsePlots, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Plots show abundance response to environmental covariates for a GAM'}

# Generate prediction data so that we can plot parametric terms
wader_df <- wader_df %>% 
  mutate(model_pred = map2(
    .x = model, 
    .y = covariate, 
    # A function to generate a response with parametric covariate only
    ~tidymv::get_gam_predictions(model = .x,
                                 series = .y, 
                                 # We want the response not link
                                 transform = exp)))

# Generate plot for each model
wader_df <- wader_df %>%
  # Use a column to store plots
  mutate(
    plots = pmap(
      list(w = Species , c = covariate, cs = p.value, m = model_pred, d = period),
      function(w,c,cs,m,d){
         ggplot(data = m) +
         # Plot parametric coefficient - red for plots with p <= 0.05
         geom_line(aes(x=value,y=count_sm), colour = if_else(cs>0.05, 1,2)) + 
         # Plot confidence interval
         geom_ribbon(aes(x =value, ymin=CI_lower,ymax=CI_upper), alpha=0.2) +
         # x axis label set to covariate in model  
         xlab(c) +
         # y axis label set to wader name  
         ylab(paste(w, if_else(d == "2002-2019", "pop chg ratio", "density"), sep = " ")) +
         theme_bw(base_size = 6) +
         theme(legend.position = 'none')
      }))

# Generate output
wader_df %>% 
  # We dont want the population change plots
  filter(period !="2002-2019") %>%
  ungroup %>% 
  dplyr::select(period, plots) %>%
  # Group plots into date ranges
  group_by(period) %>%
  # Map plotting over group
  group_map(
    ~marrangeGrob(.x$plots, 
                  nrow =5, 
                  ncol = 2,
                  # .y gives the key of the grouping variable
                  top = as.character(.y)
                  ))
```

# Parameters for GAM population change response model {#gam-pop-chg-params}

```{r tableGamParamsPopChg, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='GAM parameter estimates, standard errors, z and P values from models incorporating parameteric terms associated with abundance (in 2002-2010 and 2011-2019)'}
# create table of results of gam fit for each species - abundance response only
wader_df %>%
    dplyr::select(Species, period, covariate,estimate:p.value) %>%
    filter(period == "2002-2019") %>%
    kableExtra::kable(
      align = c('c','l','l','c','c','c','c'),
      col.names = c("Species","Period", "Covariate","Estimate",	"se", "z", "p-value")) %>%
    kable_styling(full_width = T, font_size = 12) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:2, valign = "top") 
```

# Plots for GAM population change response model {#gam-pop-chg-plots}

```{r popChgPlots, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Plots show population change to environmental covariates for a GAM, acrossall wader species'}
library(gridExtra)
# Generate output
wader_df %>% 
  # We only want the population change plots
  filter(period == "2002-2019") %>%
  ungroup %>% 
  dplyr::select(period, plots) %>%
  # Group plots into date ranges
  group_by(period) %>%
  # Map plotting over group
  group_map(
    ~marrangeGrob(.x$plots, 
                  nrow =5, 
                  ncol = 2,
                  # .y gives the key of the grouping variable
                  top = as.character(.y)
                  ))
```

# Parameters for abundance response with information theory covariates {#gam-it-resp-params}

```{r tableGamParamsITAbundance, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='GAM parameter estimates, standard errors, z and P values from models incorporating parameteric terms associated with abundance (in 2002-2010 and 2011-2019) and Information Theory covariates'}

# Load cached data
it_wader_df <- readRDS("~/Documents/GitHub/shetlandwaders/data/cacheddata/it_abun_data")

# create table of results of gam fit for each species - abundance response only
it_wader_df %>%
    dplyr::select(Species, period,covariate,estimate:p.value) %>%
    filter(period != "2002-2019") %>%
    kableExtra::kable(
      align = c('c','l','l','c','c','c','c'),
      col.names = c("Species","Response","Covariate",	"Estimate",	"se", "z", "p-value")) %>%
    kable_styling(full_width = T, font_size = 12) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:2, valign = "top") 

```

# Plots for abundance response with information theory covariates {#gam-it-resp-plots}

```{r itResponsePlots, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Plots show abundance response to information theory covariates for a GAM'}
# Generate prediction data so that we can plot parametric terms
it_wader_df <- it_wader_df %>% 
  mutate(model_pred = map2(
    .x = model, 
    .y = covariate, 
    # A function to generate a response with parametric covariate only
    ~tidymv::get_gam_predictions(model = .x,
                                 series = .y, 
                                 # We want the response not link
                                 transform = exp)))

# Generate plot for each model
it_wader_df <- it_wader_df %>%
  # Use a column to store plots
  mutate(
    plots = pmap(
      list(w = Species , c = covariate, cs = p.value, m = model_pred, d = period),
      function(w,c,cs,m,d){
         ggplot(data = m) +
         # Plot parametric coefficient - red for plots with p <= 0.05
         geom_line(aes(x=value,y=count_sm), colour = if_else(cs>0.05, 1,2)) + 
         # Plot confidence interval
         geom_ribbon(aes(x =value, ymin=CI_lower,ymax=CI_upper), alpha=0.2) +
         # x axis label set to covariate in model  
         xlab(c) +
         # y axis label set to wader name  
         ylab(paste(w, if_else(d == "2002-2019", "pop chg ratio", "density"), sep = " ")) +
         theme_bw(base_size = 6) +
         theme(legend.position = 'none')
      }))

# Library to arrange plots into pages
library(gridExtra)

# Generate output
it_wader_df %>% 
  # We dont want the population change plots
  filter(period !="2002-2019") %>%
  ungroup %>% 
  dplyr::select(period, plots) %>%
  # Group plots into date ranges
  group_by(period) %>%
  # Map plotting over group
  group_map(
    ~marrangeGrob(.x$plots, 
                  nrow =5, 
                  ncol = 2,
                  # .y gives the key of the grouping variable
                  top = as.character(.y)
                  ))

```

# Parameters for population change response model with informtion theory covariates {#gam-it-pop-chg-params}

```{r tableGamParamsITPopChg, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='GAM parameter estimates, standard errors, z and P values from models incorporating parameteric terms associated with abundance (in 2002-2010 and 2011-2019)'}
# create table of results of gam fit for each species - population change only
it_wader_df %>%
    dplyr::select(Species, period, covariate,estimate:p.value) %>%
    filter(period == "2002-2019") %>%
    kableExtra::kable(
      align = c('c','l','l','c','c','c','c'),
      col.names = c("Species","Period", "Covariate","Estimate",	"se", "z", "p-value")) %>%
    kable_styling(full_width = T, font_size = 12) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:2, valign = "top") 
```

# Plots for population change response model with informtion theory covariates {#gam-it-pop-chg-plots}

```{r itPopChgPlots, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Plots show population change to information theory covariates for a GAM, across all wader species' }
# Generate output
it_wader_df %>% 
  # We dont want the population change plots
  filter(period =="2002-2019") %>%
  ungroup %>% 
  dplyr::select(period, plots) %>%
  # Group plots into date ranges
  group_by(period) %>%
  # Map plotting over group
  group_map(
    ~marrangeGrob(.x$plots, 
                  nrow =5, 
                  ncol = 2,
                  # .y gives the key of the grouping variable
                  top = as.character(.y)
                  ))

```

# Abundance model hyper parameters for initial fit {#hyp-params}

```{r showTuneResults, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 0.8, fig.cap='Root mean squared evaluation of hyper parameters across all species'}
# Load cached results from initial tuning
species_df <- readRDS("~/Documents/GitHub/shetlandwaders/data/cacheddata/abun_ml_1")
# Generate metrics for each species tuning run
# Then map into plots of tuning parameter ranges
species_df <- species_df %>% 
  mutate(tune_plot=map2(
    .x=tune_res,
    .y=Species,
    ~collect_metrics(.x) %>%
      filter(.metric == "rmse") %>%
      dplyr::select(mean, min_n, mtry) %>%
      pivot_longer(min_n:mtry,
        values_to = "value",
        names_to = "parameter") %>%
      # Map to plots
      ggplot(aes(value, mean, color = parameter)) +
             geom_point(show.legend = FALSE) +
             facet_wrap(~parameter, scales = "free_x") +
             # Add Species name to each plot
             labs(title = .y, x = NULL, y = "rmse")))

# Plot the results
species_df$tune_plot      

# Drop the plot data column
species_df <- species_df %>% dplyr::select(-tune_plot)
```

# Abundance model hyper parameters final fit {#final-fit}

```{r plotRetuneResults, echo=FALSE, message=FALSE, warning=FALSE}
# Load cached retune results 
species_df <- readRDS("~/Documents/GitHub/shetlandwaders/data/cacheddata/abun_ml_2")
# Plot results
# Then map into plots of tuning parameter ranges
species_df <-species_df %>% 
  mutate(retune_plot=map2(
    .x=retune_res,
    .y=Species,
    ~collect_metrics(.x) %>%
      filter(.metric == "rmse") %>%
      mutate(min_n = factor(min_n)) %>%
      # Map to plots
      ggplot(aes(x=mtry, y=mean, color = min_n)) +
         geom_line(alpha = 0.5, size = 1.5) +
         geom_point() +
         labs(title=.y, y = "rmse")))

# Plot parameters of returned models
species_df$retune_plot
# Choose the best model
```

# Abundance model variable importance plots {#vip-plots}

```{r echo=FALSE, message=FALSE, warning=FALSE, varImpPlots, fig.cap='Variable Importance Plot of Abundance Model by Species'}
pl <- readRDS("~/Documents/GitHub/shetlandwaders/data/cacheddata/vip_plots")
pl$vip_plots
```
# Shetland breeding wader population estimates (numbers of pairs) {#pop-results}

```{r abunResultsTable, echo=FALSE, message=FALSE, warning=FALSE}
# Load results to tabulate
results_df <- readRDS("~/Documents/GitHub/shetlandwaders/data/cacheddata/abun_results")
# Knit table of results
results_df$pop %>% 
  as.data.frame() %>% 
  bind_cols(Species = results_df$Species, Year = results_df$Year, .) %>% 
  mutate(across(is.numeric, ~ round(., 0))) %>% 
  kableExtra::kable(
    align = c('c','c','c','c','c'),
    col.names = c("Species","Year", "Mean",	"Lower CI", "Upper CI")) %>%
    kable_styling(full_width = T, font_size = 12) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1, valign = "top") 

``` 

