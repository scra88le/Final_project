## Information Theory (IT) covariates 

### Histograms of Information theory covariates

Histograms of information theory covariates across all of Shetland

```{r itHisto, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Histograms of Information Theory covariates across all Shetland OS 1km squares'}
# Plot histogram
histo_covars %>%
  # pivot long by IT metrics
  pivot_longer(cols=c('Marginal entropy':'Relative mutual informaton'), 
               names_to = "covar",
               values_to = "value") %>%
  # Remove zero values as this makes it hard to see the distribution
  filter(value >0) %>%
  ggplot(aes(x = value)) + 
  # plot the histogram
  stat_bin(color = "black", bins=20) +
  theme_minimal() +
  labs(x = "Information Theory covariate", y = "Frequency") +
  facet_wrap(~covar, ncol=2, scales="free")
```

### Histogarams of Information Theory covariates for surveyed sqaures only

```{r itSBBSHisto, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Histograms of Information Theory covariates across SBBS surveyed sqaures only '}
# Load covar data for surveyed BBS squares
bbs_covars <- surveyed_PLAN_NO %>% 
  dplyr::left_join(histo_covars, by="PLAN_NO") %>%
  na.omit() %>%
  st_drop_geometry()

# Plot histogram
bbs_covars %>%
  # pivot long by sIT metrics
  pivot_longer(cols=c('Marginal entropy':'Relative mutual informaton'), 
               names_to = "covar",
               values_to = "value") %>%
  # Remove zero values as this makes it hard to see the distribution
  filter(value >0) %>%
  ggplot(aes(x = value)) + 
  # plot the histogram
  stat_bin(color = "black", bins=20) +
  theme_minimal() +
  labs(x = "Environmental covariate", y = "Frequency") +
  facet_wrap(~covar, ncol=2, scales="free")

```

### Information Theory covariates abundance response model

Here we generate models using Information Theory metrics as covariates against abundance count data.

```{r itGam,  message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Information Metrics as covariates for abundance response'}

it_wader_df <- wader_covars_df %>% 
  # Structure data by covariate and then group
  # pivot long by sIT metrics
  pivot_longer(cols=c('Marginal entropy':'Relative mutual informaton'), 
               names_to = "covariate",
               values_to = "value") %>%
  group_by(period, Species, covariate) %>%
  nest() %>%
  mutate(model = map2(.x = data,
                      .y = period,
                      # Generate a univariate GAM model for wader count against covariate (value).
                      # Repeat for each combination of wader and covariate 
                      ~ gam(count_sm ~ s(X,Y, k=20) + value,
                                      # Apply a different offset depending on whether this gam
                                      # models population change or only covariate response
                                      offset = case_when(.y == "2002-2019" ~ log(count_offset), 
                                                         .y != "2002-2019" ~ log(d) + log(9)),
                                      family = poisson(link="log"),
                                      method = "REML",
                                      data = .x)),
    # Summarise model config for reporting
  model_smry = map(model, ~tidy(.,parametric=TRUE)  )) %>%
  unnest(cols=model_smry) %>%
  filter(term != "(Intercept)") %>%
  dplyr::select(-term)

```

Abundance

```{r tableGamParamsITAbundance, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='GAM parameter estimates, standard errors, z and P values from models incorporating parameteric terms associated with abundance (in 2002-2010 and 2011-2019) and Information Theory covariates'}
# create table of results of gam fit for each species - abundance response only
library(kableExtra)
it_wader_df %>%
    dplyr::select(Species, period,covariate,estimate:p.value) %>%
    filter(period != "2002-2019") %>%
    kableExtra::kable(
      align = c('c','l','l','c','c','c','c'),
      col.names = c("Species","Response","Covariate",	"Estimate",	"se", "z", "p-value")) %>%
    kable_styling(full_width = F, font_size = 10) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:2, valign = "top") 

```

Plots for abundance response against IT covariates

```{r itResponsePlots, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Plots show abundance response to information theory covariates for a GAM'}
# Generate prediction data so that we can plot parametric terms
it_wader_df <- it_wader_df %>% 
  mutate(model_pred = map2(
    .x = model, 
    .y = covariate, 
    # A function to generate a response with parametric covariate only
    ~tidymv::get_gam_predictions(model = .x,
                                 series = .y, 
                                 # We want the response not link
                                 transform = exp)))

# Generate plot for each model
it_wader_df <- it_wader_df %>%
  # Use a column to store plots
  mutate(
    plots = pmap(
      list(w = Species , c = covariate, cs = p.value, m = model_pred, d = period),
      function(w,c,cs,m,d){
         ggplot(data = m) +
         # Plot parametric coefficient - red for plots with p <= 0.05
         geom_line(aes(x=value,y=count_sm), colour = if_else(cs>0.05, 1,2)) + 
         # Plot confidence interval
         geom_ribbon(aes(x =value, ymin=CI_lower,ymax=CI_upper), alpha=0.2) +
         # x axis label set to covariate in model  
         xlab(c) +
         # y axis label set to wader name  
         ylab(paste(w, if_else(d == "2002-2019", "pop chg ratio", "density"), sep = " ")) +
         theme_bw(base_size = 6) +
         theme(legend.position = 'none')
      }))

# Library to arrange plots into pages
library(gridExtra)

# Generate output
it_wader_df %>% 
  # We dont want the population change plots
  filter(period !="2002-2019") %>%
  ungroup %>% 
  dplyr::select(period, plots) %>%
  # Group plots into date ranges
  group_by(period) %>%
  # Map plotting over group
  group_map(
    ~marrangeGrob(.x$plots, 
                  nrow =5, 
                  ncol = 2,
                  # .y gives the key of the grouping variable
                  top = as.character(.y)
                  ))

```


Population change

```{r tableGamParamsITPopChg, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='GAM parameter estimates, standard errors, z and P values from models incorporating parameteric terms associated with abundance (in 2002-2010 and 2011-2019)'}
# create table of results of gam fit for each species - population change only
it_wader_df %>%
    dplyr::select(Species, period, covariate,estimate:p.value) %>%
    filter(period == "2002-2019") %>%
    kableExtra::kable(
      align = c('c','l','l','c','c','c','c'),
      col.names = c("Species","Period", "Covariate","Estimate",	"se", "z", "p-value")) %>%
    kable_styling(full_width = F, font_size = 10) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:2, valign = "top") 
```

Plots for population change against information theory covariates

```{r itPopChgPlots, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.asp= 1, fig.cap='Plots show population change to information theory covariates for a GAM, across all wader species' }
# Generate output
it_wader_df %>% 
  # We dont want the population change plots
  filter(period =="2002-2019") %>%
  ungroup %>% 
  dplyr::select(period, plots) %>%
  # Group plots into date ranges
  group_by(period) %>%
  # Map plotting over group
  group_map(
    ~marrangeGrob(.x$plots, 
                  nrow =5, 
                  ncol = 2,
                  # .y gives the key of the grouping variable
                  top = as.character(.y)
                  ))

```